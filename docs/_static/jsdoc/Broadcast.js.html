

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: Broadcast.js | Ranvier</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="../../assets/stylesheets/srcdocs.css">
        
            <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|PT+Mono|Material+Icons|Fugaz+One">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 120px; height: 120px">
        <img src="../images/logo.png" width="100%" height="100%">
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Ranvier</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="BehaviorManager.html">BehaviorManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BehaviorManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BehaviorManager.html#addListener">addListener</a></li><li><a href="BehaviorManager.html#get">get</a></li><li><a href="BehaviorManager.html#has">has</a></li></ul></div></li><li><a href="Channel.html">Channel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Channel_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Channel.html#formatToReceipient">formatToReceipient</a></li><li><a href="Channel.html#formatToSender">formatToSender</a></li><li><a href="Channel.html#send">send</a></li></ul></div></li><li><a href="Character.html">Character</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Character_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Character.html#addCombatant">addCombatant</a></li><li><a href="Character.html#calculateWeaponDamage">calculateWeaponDamage</a></li><li><a href="Character.html#emit">emit</a></li><li><a href="Character.html#evaluateIncomingDamage">evaluateIncomingDamage</a></li><li><a href="Character.html#evaluateOutgoingDamage">evaluateOutgoingDamage</a></li><li><a href="Character.html#findCombatant">findCombatant</a></li><li><a href="Character.html#getMaxAttribute">getMaxAttribute</a></li><li><a href="Character.html#initiateCombat">initiateCombat</a></li><li><a href="Character.html#isInCombat">isInCombat</a></li><li><a href="Character.html#normalizeWeaponDamage">normalizeWeaponDamage</a></li><li><a href="Character.html#removeCombatant">removeCombatant</a></li><li><a href="Character.html#removeFromCombat">removeFromCombat</a></li><li><a href="Character.html#serialize">serialize</a></li></ul></div></li><li><a href="ClassManager.html">ClassManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ClassManager_sub"></div></li><li><a href="Command.html">Command</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Command_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Command.html#execute">execute</a></li></ul></div></li><li><a href="CommandParser.html">CommandParser</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CommandParser_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="CommandParser.html#.parse">parse</a></li><li><a href="CommandParser.html#.parseDot">parseDot</a></li></ul></div></li><li><a href="Damage.html">Damage</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Damage_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Damage.html#commit">commit</a></li><li><a href="Damage.html#evaluate">evaluate</a></li></ul></div></li><li><a href="Effect.html">Effect</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Effect_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Effect.html#elapsed">elapsed</a></li><li><a href="Effect.html#remaining">remaining</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Effect.html#modifyAttribute">modifyAttribute</a></li><li><a href="Effect.html#modifyIncomingDamage">modifyIncomingDamage</a></li><li><a href="Effect.html#modifyOutgoingDamage">modifyOutgoingDamage</a></li><li><a href="Effect.html#remove">remove</a></li></ul></div></li><li><a href="EffectFactory.html">EffectFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EffectFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EffectFactory.html#add">add</a></li><li><a href="EffectFactory.html#create">create</a></li><li><a href="EffectFactory.html#get">get</a></li></ul></div></li><li><a href="EffectList.html">EffectList</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EffectList_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EffectList.html#add">add</a></li><li><a href="EffectList.html#emit">emit</a></li><li><a href="EffectList.html#entries">entries</a></li><li><a href="EffectList.html#evaluateAttribute">evaluateAttribute</a></li><li><a href="EffectList.html#evaluateIncomingDamage">evaluateIncomingDamage</a></li><li><a href="EffectList.html#evaluateOutgoingDamage">evaluateOutgoingDamage</a></li><li><a href="EffectList.html#remove">remove</a></li><li><a href="EffectList.html#validateEffects">validateEffects</a></li></ul></div></li><li><a href="EntityFactory.html">EntityFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EntityFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EntityFactory.html#addScriptListener">addScriptListener</a></li><li><a href="EntityFactory.html#clone">clone</a></li><li><a href="EntityFactory.html#createByType">createByType</a></li><li><a href="EntityFactory.html#createEntityRef">createEntityRef</a></li><li><a href="EntityFactory.html#getDefinition">getDefinition</a></li><li><a href="EntityFactory.html#setDefinition">setDefinition</a></li></ul></div></li><li><a href="EventManager.html">EventManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EventManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EventManager.html#add">add</a></li><li><a href="EventManager.html#attach">attach</a></li><li><a href="EventManager.html#detach">detach</a></li><li><a href="EventManager.html#get">get</a></li></ul></div></li><li><a href="Item.html">Item</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Item_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Item.html#display">display</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Item.html#findOwner">findOwner</a></li><li><a href="Item.html#getBehavior">getBehavior</a></li><li><a href="Item.html#hasBehavior">hasBehavior</a></li><li><a href="Item.html#qualityColorize">qualityColorize</a></li></ul></div></li><li><a href="ItemFactory.html">ItemFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ItemFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ItemFactory.html#create">create</a></li></ul></div></li><li><a href="MobFactory.html">MobFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MobFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="MobFactory.html#create">create</a></li></ul></div></li><li><a href="Npc.html">Npc</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Npc_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Npc.html#getBehavior">getBehavior</a></li><li><a href="Npc.html#hasBehavior">hasBehavior</a></li><li><a href="Npc.html#moveTo">moveTo</a></li></ul></div></li><li><a href="Party.html">Party</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Party_sub"></div></li><li><a href="Player.html">Player</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Player_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Player.html#addPrompt">addPrompt</a></li><li><a href="Player.html#canGo">canGo</a></li><li><a href="Player.html#emit">emit</a></li><li><a href="Player.html#getBroadcastTargets">getBroadcastTargets</a></li><li><a href="Player.html#getMeta">getMeta</a></li><li><a href="Player.html#hasPrompt">hasPrompt</a></li><li><a href="Player.html#interpolatePrompt">interpolatePrompt</a></li><li><a href="Player.html#moveTo">moveTo</a></li><li><a href="Player.html#queueCommand">queueCommand</a></li><li><a href="Player.html#removePrompt">removePrompt</a></li><li><a href="Player.html#setMeta">setMeta</a></li></ul></div></li><li><a href="PlayerClass.html">PlayerClass</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="PlayerClass_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="PlayerClass.html#abilityTable">abilityTable</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="PlayerClass.html#canUseAbility">canUseAbility</a></li><li><a href="PlayerClass.html#getAbilitiesForPlayer">getAbilitiesForPlayer</a></li><li><a href="PlayerClass.html#setupPlayer">setupPlayer</a></li></ul></div></li><li><a href="Quest.html">Quest</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Quest_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Quest.html#emit">emit</a></li><li><a href="Quest.html#getProgress">getProgress</a></li></ul></div></li><li><a href="QuestFactory.html">QuestFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QuestFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="QuestFactory.html#_makeQuestKey">_makeQuestKey</a></li><li><a href="QuestFactory.html#create">create</a></li><li><a href="QuestFactory.html#get">get</a></li></ul></div></li><li><a href="QuestTracker.html">QuestTracker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QuestTracker_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="QuestTracker.html#canStart">canStart</a></li><li><a href="QuestTracker.html#complete">complete</a></li><li><a href="QuestTracker.html#emit">emit</a></li><li><a href="QuestTracker.html#hydrate">hydrate</a></li><li><a href="QuestTracker.html#isActive">isActive</a></li><li><a href="QuestTracker.html#isComplete">isComplete</a></li><li><a href="QuestTracker.html#serialize">serialize</a></li><li><a href="QuestTracker.html#start">start</a></li></ul></div></li><li><a href="Room.html">Room</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Room_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Room.html#spawnedNpcs">spawnedNpcs</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Room.html#emit">emit</a></li><li><a href="Room.html#getBehavior">getBehavior</a></li><li><a href="Room.html#getBroadcastTargets">getBroadcastTargets</a></li><li><a href="Room.html#hasBehavior">hasBehavior</a></li></ul></div></li><li><a href="Skill.html">Skill</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Skill_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Skill.html#cooldown">cooldown</a></li><li><a href="Skill.html#execute">execute</a></li><li><a href="Skill.html#onCooldown">onCooldown</a></li><li><a href="Skill.html#payResourceCosts">payResourceCosts</a></li><li><a href="Skill.html#searchForTargets">searchForTargets</a></li></ul></div></li><li><a href="TelnetServer.html">TelnetServer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TelnetServer_sub"></div></li><li><a href="TelnetStream.html">TelnetStream</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TelnetStream_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="TelnetStream.html#input">input</a></li><li><a href="TelnetStream.html#telnetCommand">telnetCommand</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#baseAttributeByLevel">baseAttributeByLevel</a></li><li><a href="global.html#diff">diff</a></li><li><a href="global.html#EffectConfig">EffectConfig</a></li><li class="hidden"><a href="global.html#EffectModifiers">EffectModifiers</a></li><li><a href="global.html#expToLevel">expToLevel</a></li><li><a href="global.html#genWrite">genWrite</a></li><li><a href="global.html#HealthPerStaminaTable">HealthPerStaminaTable</a></li><li><a href="global.html#mobExp">mobExp</a></li><li><a href="global.html#reduction">reduction</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const ansi = require('sty');
ansi.enable(); // force ansi on even when there isn't a tty for the server
const wrap = require('wrap-ansi');
const TypeUtil = require('./TypeUtil');
const Broadcastable = require('./Broadcastable');

class Broadcast {
  static at(source, message = '', wrapWidth = false, useColor = true, formatter = null) {
    useColor = typeof useColor === 'boolean' ? useColor : true;
    formatter = formatter || ((target, message) => message);

    if (!TypeUtil.is(source, Broadcastable)) {
      throw new Error(`Tried to broadcast message not non-broadcastable object: MESSAGE [${message}]`);
    }

    message = Broadcast._fixNewlines(message);

    const targets = source.getBroadcastTargets();
    targets.forEach(target => {
      if (target.socket &amp;&amp; target.socket.writable) {
        if (target.socket._prompted) {
          target.socket.write('\r\n');
          target.socket._prompted = false;
        }
        let targetMessage = formatter(target, message);
        targetMessage = wrapWidth ? Broadcast.wrap(targetMessage, wrapWidth) : ansi.parse(targetMessage);
        target.socket.write(targetMessage);
      }
    });
  }

  static atExcept(source, message, excludes, wrapWidth, useColor, formatter) {

    if (!TypeUtil.is(source, Broadcastable)) {
      throw new Error(`Tried to broadcast message not non-broadcastable object: MESSAGE [${message}]`);
    }

    // Could be an array or a single target.
    excludes = [].concat(excludes);

    const targets = source.getBroadcastTargets()
      .filter(target => !excludes.includes(target));

    const newSource = {
      getBroadcastTargets: () => targets
    };

    Broadcast.at(newSource, message, wrapWidth, useColor, formatter);

  }

  static atFormatted(source, message, formatter, wrapWidth, useColor) {
    Broadcast.at(source, message, wrapWidth, useColor, formatter);
  }

  static sayAt(source, message, wrapWidth, useColor, formatter) {
    Broadcast.at(source, message, wrapWidth, useColor, (target, message) => {
      return (formatter ? formatter(target, message) : message ) + '\r\n';
    });
  }

  static sayAtExcept(source, message, excludes, wrapWidth, useColor, formatter) {
    Broadcast.atExcept(source, message, excludes, wrapWidth, useColor, (target, message) => {
      return (formatter ? formatter(target, message) : message ) + '\r\n';
    });
  }

  static sayAtFormatted(source, message, formatter, wrapWidth, useColor) {
    Broadcast.sayAt(source, message, wrapWidth, useColor, formatter);
  }

  static isBroadcastable(obj) {
    return Reflect.has(obj, 'getBroadcastTargets');
  }

  /**
   * Render the player's prompt including any extra prompts
   * @param {Player} player
   * @param {object} extra     extra data to avail to the prompt string interpolator
   * @param {number} wrapWidth
   * @param {boolean} useColor
   */
  static prompt(player, extra, wrapWidth, useColor) {
    player.socket._prompted = false;
    Broadcast.at(player, '\r\n' + player.interpolatePrompt(player.prompt, extra) + ' ', wrapWidth, useColor);
    let needsNewline = player.extraPrompts.size > 0;
    if (needsNewline) {
      Broadcast.sayAt(player);
    }

    for (const [id, extraPrompt] of player.extraPrompts) {
      Broadcast.sayAt(player, extraPrompt.renderer(), wrapWidth, useColor);
      if (extraPrompt.removeOnRender) {
        player.removePrompt(id);
      }
    }

    if (needsNewline) {
      Broadcast.at(player, '> ');
    }

    player.socket._prompted = true;
    if (player.socket.writable) {
      player.socket.goAhead();
    }
  }

  /**
   * Generate an ASCII art progress bar
   * @param {number} width Max width
   * @param {number} percent Current percent
   * @param {string} color
   * @param {string} barChar Character to use for the current progress
   * @param {string} fillChar Character to use for the rest
   * @param {string} delimiters Characters to wrap the bar in
   * @return {string}
   */
  static progress(width, percent, color, barChar = "#", fillChar = " ", delimiters = "()") {
    percent = Math.max(0, percent);
    width -= 3; // account for delimiters and tip of bar
    if (percent === 100) {
        width++; // 100% bar doesn't have a second right delimiter
    }
    barChar = barChar[0];
    fillChar = fillChar[0];
    const [ leftDelim, rightDelim ] = delimiters;
    const openColor = `&lt;${color}>`;
    const closeColor = `&lt;/${color}>`;
    let buf = openColor + leftDelim + "&lt;bold>";
    const widthPercent = Math.round((percent / 100) * width);
    buf += Broadcast.line(widthPercent, barChar) + (percent === 100 ? '' : rightDelim);
    buf += Broadcast.line(width - widthPercent, fillChar);
    buf += "&lt;/bold>" + rightDelim + closeColor;
    return buf;
  }

  /**
   * Center a string in the middle of a given width
   * @param {number} width
   * @param {string} message
   * @param {string} color
   * @param {?string} fillChar Character to pad with, defaults to ' '
   * @return {string}
   */
  static center(width, message, color, fillChar = " ") {
    const padWidth = width / 2 - message.length / 2;
    let openColor = '';
    let closeColor = '';
    if (color) {
      openColor = `&lt;${color}>`;
      closeColor = `&lt;/${color}>`;
    }

    return (
      openColor +
      Broadcast.line(Math.floor(padWidth), fillChar) +
      message +
      Broadcast.line(Math.ceil(padWidth), fillChar) +
      closeColor
    );
  }

  /**
   * Render a line of a specific width/color
   * @param {number} width
   * @param {string} fillChar
   * @param {?string} color
   * @return {string}
   */
  static line(width, fillChar = "-", color = null) {
    let openColor = '';
    let closeColor = '';
    if (color) {
      openColor = `&lt;${color}>`;
      closeColor = `&lt;/${color}>`;
    }
    return openColor + (new Array(width + 1)).join(fillChar) + closeColor;
  }

  /**
   * Wrap a message to a given width. Note: Evaluates color tags
   * @param {string}  message
   * @param {?number} width   Defaults to 80
   * @return {string}
   */
  static wrap(message, width = 80) {
    return Broadcast._fixNewlines(wrap(ansi.parse(message), width));
  }

  /**
   * Indent all lines of a given string by a given amount
   * @param {string} message
   * @param {number} indent
   * @return {string}
   */
  static indent(message, indent) {
    message = Broadcast._fixNewlines(message);
    const padding = Broadcast.line(indent, ' ');
    return padding + message.replace(/\r\n/g, '\r\n' + padding);
  }

  /**
   * Fix LF unpaired with CR for windows output
   * @param {string} message
   * @return {string}
   */
  static _fixNewlines(message) {
    // Fix \n not in a \r\n pair to prevent bad rendering on windows
    message = message.replace(/\r\n/g, '&lt;NEWLINE>').split('\n');
    message = message.join('\r\n').replace(/&lt;NEWLINE>/g, '\r\n');
    // fix sty's incredibly stupid default of always appending ^[[0m
    return message.replace(/\x1B\[0m$/, '');
  }
}

module.exports = Broadcast;
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="../images/logo.png" style="width: 120px; height: 120px">
    <div class="footer-text">Copyright © 2017, Shawn Biddle</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
