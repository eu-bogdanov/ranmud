

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: Effect.js | Ranvier</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="../../assets/stylesheets/srcdocs.css">
        
            <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|PT+Mono|Material+Icons|Fugaz+One">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 120px; height: 120px">
        <img src="../images/logo.png" width="100%" height="100%">
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Ranvier</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="BehaviorManager.html">BehaviorManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BehaviorManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BehaviorManager.html#addListener">addListener</a></li><li><a href="BehaviorManager.html#get">get</a></li><li><a href="BehaviorManager.html#has">has</a></li></ul></div></li><li><a href="Channel.html">Channel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Channel_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Channel.html#formatToReceipient">formatToReceipient</a></li><li><a href="Channel.html#formatToSender">formatToSender</a></li><li><a href="Channel.html#send">send</a></li></ul></div></li><li><a href="Character.html">Character</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Character_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Character.html#addCombatant">addCombatant</a></li><li><a href="Character.html#calculateWeaponDamage">calculateWeaponDamage</a></li><li><a href="Character.html#emit">emit</a></li><li><a href="Character.html#evaluateIncomingDamage">evaluateIncomingDamage</a></li><li><a href="Character.html#evaluateOutgoingDamage">evaluateOutgoingDamage</a></li><li><a href="Character.html#findCombatant">findCombatant</a></li><li><a href="Character.html#getMaxAttribute">getMaxAttribute</a></li><li><a href="Character.html#initiateCombat">initiateCombat</a></li><li><a href="Character.html#isInCombat">isInCombat</a></li><li><a href="Character.html#normalizeWeaponDamage">normalizeWeaponDamage</a></li><li><a href="Character.html#removeCombatant">removeCombatant</a></li><li><a href="Character.html#removeFromCombat">removeFromCombat</a></li><li><a href="Character.html#serialize">serialize</a></li></ul></div></li><li><a href="ClassManager.html">ClassManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ClassManager_sub"></div></li><li><a href="Command.html">Command</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Command_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Command.html#execute">execute</a></li></ul></div></li><li><a href="CommandParser.html">CommandParser</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CommandParser_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="CommandParser.html#.parse">parse</a></li><li><a href="CommandParser.html#.parseDot">parseDot</a></li></ul></div></li><li><a href="Damage.html">Damage</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Damage_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Damage.html#commit">commit</a></li><li><a href="Damage.html#evaluate">evaluate</a></li></ul></div></li><li><a href="Effect.html">Effect</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Effect_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Effect.html#elapsed">elapsed</a></li><li><a href="Effect.html#remaining">remaining</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Effect.html#modifyAttribute">modifyAttribute</a></li><li><a href="Effect.html#modifyIncomingDamage">modifyIncomingDamage</a></li><li><a href="Effect.html#modifyOutgoingDamage">modifyOutgoingDamage</a></li><li><a href="Effect.html#remove">remove</a></li></ul></div></li><li><a href="EffectFactory.html">EffectFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EffectFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EffectFactory.html#add">add</a></li><li><a href="EffectFactory.html#create">create</a></li><li><a href="EffectFactory.html#get">get</a></li></ul></div></li><li><a href="EffectList.html">EffectList</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EffectList_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EffectList.html#add">add</a></li><li><a href="EffectList.html#emit">emit</a></li><li><a href="EffectList.html#entries">entries</a></li><li><a href="EffectList.html#evaluateAttribute">evaluateAttribute</a></li><li><a href="EffectList.html#evaluateIncomingDamage">evaluateIncomingDamage</a></li><li><a href="EffectList.html#evaluateOutgoingDamage">evaluateOutgoingDamage</a></li><li><a href="EffectList.html#remove">remove</a></li><li><a href="EffectList.html#validateEffects">validateEffects</a></li></ul></div></li><li><a href="EntityFactory.html">EntityFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EntityFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EntityFactory.html#addScriptListener">addScriptListener</a></li><li><a href="EntityFactory.html#clone">clone</a></li><li><a href="EntityFactory.html#createByType">createByType</a></li><li><a href="EntityFactory.html#createEntityRef">createEntityRef</a></li><li><a href="EntityFactory.html#getDefinition">getDefinition</a></li><li><a href="EntityFactory.html#setDefinition">setDefinition</a></li></ul></div></li><li><a href="EventManager.html">EventManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EventManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EventManager.html#add">add</a></li><li><a href="EventManager.html#attach">attach</a></li><li><a href="EventManager.html#detach">detach</a></li><li><a href="EventManager.html#get">get</a></li></ul></div></li><li><a href="Item.html">Item</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Item_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Item.html#display">display</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Item.html#findOwner">findOwner</a></li><li><a href="Item.html#getBehavior">getBehavior</a></li><li><a href="Item.html#hasBehavior">hasBehavior</a></li><li><a href="Item.html#qualityColorize">qualityColorize</a></li></ul></div></li><li><a href="ItemFactory.html">ItemFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ItemFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ItemFactory.html#create">create</a></li></ul></div></li><li><a href="MobFactory.html">MobFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MobFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="MobFactory.html#create">create</a></li></ul></div></li><li><a href="Npc.html">Npc</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Npc_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Npc.html#getBehavior">getBehavior</a></li><li><a href="Npc.html#hasBehavior">hasBehavior</a></li><li><a href="Npc.html#moveTo">moveTo</a></li></ul></div></li><li><a href="Party.html">Party</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Party_sub"></div></li><li><a href="Player.html">Player</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Player_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Player.html#addPrompt">addPrompt</a></li><li><a href="Player.html#canGo">canGo</a></li><li><a href="Player.html#emit">emit</a></li><li><a href="Player.html#getBroadcastTargets">getBroadcastTargets</a></li><li><a href="Player.html#getMeta">getMeta</a></li><li><a href="Player.html#hasPrompt">hasPrompt</a></li><li><a href="Player.html#interpolatePrompt">interpolatePrompt</a></li><li><a href="Player.html#moveTo">moveTo</a></li><li><a href="Player.html#queueCommand">queueCommand</a></li><li><a href="Player.html#removePrompt">removePrompt</a></li><li><a href="Player.html#setMeta">setMeta</a></li></ul></div></li><li><a href="PlayerClass.html">PlayerClass</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="PlayerClass_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="PlayerClass.html#abilityTable">abilityTable</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="PlayerClass.html#canUseAbility">canUseAbility</a></li><li><a href="PlayerClass.html#getAbilitiesForPlayer">getAbilitiesForPlayer</a></li><li><a href="PlayerClass.html#setupPlayer">setupPlayer</a></li></ul></div></li><li><a href="Quest.html">Quest</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Quest_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Quest.html#emit">emit</a></li><li><a href="Quest.html#getProgress">getProgress</a></li></ul></div></li><li><a href="QuestFactory.html">QuestFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QuestFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="QuestFactory.html#_makeQuestKey">_makeQuestKey</a></li><li><a href="QuestFactory.html#create">create</a></li><li><a href="QuestFactory.html#get">get</a></li></ul></div></li><li><a href="QuestTracker.html">QuestTracker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QuestTracker_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="QuestTracker.html#canStart">canStart</a></li><li><a href="QuestTracker.html#complete">complete</a></li><li><a href="QuestTracker.html#emit">emit</a></li><li><a href="QuestTracker.html#hydrate">hydrate</a></li><li><a href="QuestTracker.html#isActive">isActive</a></li><li><a href="QuestTracker.html#isComplete">isComplete</a></li><li><a href="QuestTracker.html#serialize">serialize</a></li><li><a href="QuestTracker.html#start">start</a></li></ul></div></li><li><a href="Room.html">Room</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Room_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Room.html#spawnedNpcs">spawnedNpcs</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Room.html#emit">emit</a></li><li><a href="Room.html#getBehavior">getBehavior</a></li><li><a href="Room.html#getBroadcastTargets">getBroadcastTargets</a></li><li><a href="Room.html#hasBehavior">hasBehavior</a></li></ul></div></li><li><a href="Skill.html">Skill</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Skill_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Skill.html#cooldown">cooldown</a></li><li><a href="Skill.html#execute">execute</a></li><li><a href="Skill.html#onCooldown">onCooldown</a></li><li><a href="Skill.html#payResourceCosts">payResourceCosts</a></li><li><a href="Skill.html#searchForTargets">searchForTargets</a></li></ul></div></li><li><a href="TelnetServer.html">TelnetServer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TelnetServer_sub"></div></li><li><a href="TelnetStream.html">TelnetStream</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TelnetStream_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="TelnetStream.html#input">input</a></li><li><a href="TelnetStream.html#telnetCommand">telnetCommand</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#baseAttributeByLevel">baseAttributeByLevel</a></li><li><a href="global.html#diff">diff</a></li><li><a href="global.html#EffectConfig">EffectConfig</a></li><li class="hidden"><a href="global.html#EffectModifiers">EffectModifiers</a></li><li><a href="global.html#expToLevel">expToLevel</a></li><li><a href="global.html#genWrite">genWrite</a></li><li><a href="global.html#HealthPerStaminaTable">HealthPerStaminaTable</a></li><li><a href="global.html#mobExp">mobExp</a></li><li><a href="global.html#reduction">reduction</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const EventEmitter = require('events');

 /** @typedef EffectModifiers {{attributes: !Object&lt;string,function>}} */
var EffectModifiers;

/**
 * @property {object}  config Effect configuration (name/desc/duration/etc.)
 * @property {boolean} config.autoActivate If this effect immediately activates itself when added to the target
 * @property {boolean} config.hidden       If this effect is shown in the character's effect list
 * @property {boolean} config.unique       If multiple effects with the same `config.type` can be applied at once
 * @property {number}  config.maxStacks    When adding an effect of the same type it adds a stack to the current
 *     effect up to maxStacks instead of adding the effect. Implies `config.unique`
 * @property {boolean} config.persists     If false the effect will not save to the player
 * @property {string}  config.type         The effect category, mainly used when disallowing stacking
 * @property {boolean|number} config.tickInterval Number of seconds between calls to the `updateTick` listener
 * @property {string}    description
 * @property {number}    duration    Total duration of effect in _milliseconds_
 * @property {number}    elapsed     Get elapsed time in _milliseconds_
 * @property {string}    id     filename minus .js
 * @property {EffectModifiers} modifiers Attribute modifier functions
 * @property {string}    name
 * @property {number}    remaining Number of seconds remaining
 * @property {number}    startedAt Date.now() time this effect became active
 * @property {object}    state  Configuration of this _type_ of effect (magnitude, element, stat, etc.)
 * @property {Character} target Character this effect is... effecting
 */
class Effect extends EventEmitter {
  constructor(id, def, target) {
    super();

    this.id = id;
    this.flags = def.flags || [];
    this.config = Object.assign({
      autoActivate: true,
      description: '',
      duration: Infinity,
      hidden: false,
      maxStacks: 0,
      name: 'Unnamed Effect',
      persists: true,
      tickInterval: false,
      type: 'undef',
      unique: true,
    }, def.config);

    this.target = target;
    this.startedAt = 0;
    this.paused = 0;
    this.modifiers = Object.assign({
      attributes: {},
      incomingDamage: (damage, current) => current,
      outgoingDamage: (damage, current) => current,
    }, def.modifiers);

    // internal state saved across player load e.g., stacks, amount of damage shield remaining, whatever
    // Default state can be found in config.state
    this.state = Object.assign({}, def.state);

    // If an effect has a tickInterval it should always apply when first activated
    if (this.config.tickInterval &amp;&amp; !this.state.tickInterval) {
      this.state.lastTick = -Infinity;
      this.state.ticks = 0;
    }

    if (this.config.autoActivate) {
      this.on('effectAdded', this.activate);
    }
  }

  get name() {
    return this.config.name;
  }

  get description() {
    return this.config.description;
  }

  get duration() {
    return this.config.duration;
  }

  set duration(dur) {
    this.config.duration = dur;
  }

  /**
   * @return {number}
   */
  get elapsed () {
    if (!this.startedAt) {
      return null;
    }

    return this.paused || (Date.now() - this.startedAt);
  }

  /**
   * Get remaining time in seconds
   * @return {number}
   */
  get remaining() {
    return this.config.duration - this.elapsed;
  }

  isCurrent() {
    return this.elapsed &lt; this.config.duration;
  }

  activate() {
    if (this.active) {
      return;
    }

    this.startedAt = Date.now() - this.elapsed;
    this.emit('effectActivated');
    this.active = true;
  }

  deactivate() {
    if (!this.active) {
      return;
    }

    this.emit('effectDeactivated');
    this.active = false;
  }

  /**
   * Remove this effect from its target
   */
  remove() {
    this.emit('remove');
  }

  pause() {
    this.paused = this.elapsed;
  }

  resume() {
    this.startedAt = Date.now() - this.paused;
    this.paused = null;
  }

  /**
   * @param {string} attrName
   * @param {number} currentValue
   * @return {number} attribute modified by effect
   */
  modifyAttribute(attrName, currentValue) {
    let modifier = _ => _;
    if (typeof this.modifiers.attributes === 'function') {
      modifier = (current) => {
        return this.modifiers.attributes.bind(this)(attrName, current);
      };
    } else if (attrName in this.modifiers.attributes) {
      modifier = this.modifiers.attributes[attrName];
    }
    return modifier.bind(this)(currentValue);
  }

  /**
   * @param {Damage} damage
   * @return {Damage}
   */
  modifyIncomingDamage(damage, currentAmount) {
    const modifier = this.modifiers.incomingDamage.bind(this);
    return modifier(damage, currentAmount);
  }

  /**
   * @param {Damage} damage
   * @return {Damage}
   */
  modifyOutgoingDamage(damage, currentAmount) {
    const modifier = this.modifiers.outgoingDamage.bind(this);
    return modifier(damage, currentAmount);
  }

  serialize() {
    let config = Object.assign({}, this.config);
    config.duration = config.duration === Infinity ? 'inf' : config.duration;

    let state = Object.assign({}, this.state);
    // store lastTick as a difference so we can make sure to start where we left off when we hydrate
    if (state.lastTick &amp;&amp; isFinite(state.lastTick))  {
      state.lastTick = Date.now() - state.lastTick;
    }

    return {
      id: this.id,
      elapsed: this.elapsed,
      skill: this.skill &amp;&amp; this.skill.id,
      state,
      config,
    };
  }

  hydrate(state, data) {
    data.config.duration = data.config.duration === 'inf' ? Infinity : data.config.duration;
    this.config = data.config;

    if (!isNaN(data.elapsed)) {
      this.startedAt = Date.now() - data.elapsed;
    }

    if (!isNaN(data.state.lastTick)) {
      data.state.lastTick = Date.now() - data.state.lastTick;
    }
    this.state = data.state;

    if (data.skill) {
      this.skill = state.SkillManager.get(data.skill) || state.SpellManager.get(data.skill);
    }
  }
}

module.exports = Effect;

</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="../images/logo.png" style="width: 120px; height: 120px">
    <div class="footer-text">Copyright © 2017, Shawn Biddle</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
