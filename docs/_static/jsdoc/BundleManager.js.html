

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: BundleManager.js | Ranvier</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="../../assets/stylesheets/srcdocs.css">
        
            <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|PT+Mono|Material+Icons|Fugaz+One">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 120px; height: 120px">
        <img src="../images/logo.png" width="100%" height="100%">
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Ranvier</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="BehaviorManager.html">BehaviorManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="BehaviorManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="BehaviorManager.html#addListener">addListener</a></li><li><a href="BehaviorManager.html#get">get</a></li><li><a href="BehaviorManager.html#has">has</a></li></ul></div></li><li><a href="Channel.html">Channel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Channel_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Channel.html#formatToReceipient">formatToReceipient</a></li><li><a href="Channel.html#formatToSender">formatToSender</a></li><li><a href="Channel.html#send">send</a></li></ul></div></li><li><a href="Character.html">Character</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Character_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Character.html#addCombatant">addCombatant</a></li><li><a href="Character.html#calculateWeaponDamage">calculateWeaponDamage</a></li><li><a href="Character.html#emit">emit</a></li><li><a href="Character.html#evaluateIncomingDamage">evaluateIncomingDamage</a></li><li><a href="Character.html#evaluateOutgoingDamage">evaluateOutgoingDamage</a></li><li><a href="Character.html#findCombatant">findCombatant</a></li><li><a href="Character.html#getMaxAttribute">getMaxAttribute</a></li><li><a href="Character.html#initiateCombat">initiateCombat</a></li><li><a href="Character.html#isInCombat">isInCombat</a></li><li><a href="Character.html#normalizeWeaponDamage">normalizeWeaponDamage</a></li><li><a href="Character.html#removeCombatant">removeCombatant</a></li><li><a href="Character.html#removeFromCombat">removeFromCombat</a></li><li><a href="Character.html#serialize">serialize</a></li></ul></div></li><li><a href="ClassManager.html">ClassManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ClassManager_sub"></div></li><li><a href="Command.html">Command</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Command_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Command.html#execute">execute</a></li></ul></div></li><li><a href="CommandParser.html">CommandParser</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="CommandParser_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="CommandParser.html#.parse">parse</a></li><li><a href="CommandParser.html#.parseDot">parseDot</a></li></ul></div></li><li><a href="Damage.html">Damage</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Damage_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Damage.html#commit">commit</a></li><li><a href="Damage.html#evaluate">evaluate</a></li></ul></div></li><li><a href="Effect.html">Effect</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Effect_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Effect.html#elapsed">elapsed</a></li><li><a href="Effect.html#remaining">remaining</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Effect.html#modifyAttribute">modifyAttribute</a></li><li><a href="Effect.html#modifyIncomingDamage">modifyIncomingDamage</a></li><li><a href="Effect.html#modifyOutgoingDamage">modifyOutgoingDamage</a></li><li><a href="Effect.html#remove">remove</a></li></ul></div></li><li><a href="EffectFactory.html">EffectFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EffectFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EffectFactory.html#add">add</a></li><li><a href="EffectFactory.html#create">create</a></li><li><a href="EffectFactory.html#get">get</a></li></ul></div></li><li><a href="EffectList.html">EffectList</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EffectList_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EffectList.html#add">add</a></li><li><a href="EffectList.html#emit">emit</a></li><li><a href="EffectList.html#entries">entries</a></li><li><a href="EffectList.html#evaluateAttribute">evaluateAttribute</a></li><li><a href="EffectList.html#evaluateIncomingDamage">evaluateIncomingDamage</a></li><li><a href="EffectList.html#evaluateOutgoingDamage">evaluateOutgoingDamage</a></li><li><a href="EffectList.html#remove">remove</a></li><li><a href="EffectList.html#validateEffects">validateEffects</a></li></ul></div></li><li><a href="EntityFactory.html">EntityFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EntityFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EntityFactory.html#addScriptListener">addScriptListener</a></li><li><a href="EntityFactory.html#clone">clone</a></li><li><a href="EntityFactory.html#createByType">createByType</a></li><li><a href="EntityFactory.html#createEntityRef">createEntityRef</a></li><li><a href="EntityFactory.html#getDefinition">getDefinition</a></li><li><a href="EntityFactory.html#setDefinition">setDefinition</a></li></ul></div></li><li><a href="EventManager.html">EventManager</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="EventManager_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="EventManager.html#add">add</a></li><li><a href="EventManager.html#attach">attach</a></li><li><a href="EventManager.html#detach">detach</a></li><li><a href="EventManager.html#get">get</a></li></ul></div></li><li><a href="Item.html">Item</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Item_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Item.html#display">display</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Item.html#findOwner">findOwner</a></li><li><a href="Item.html#getBehavior">getBehavior</a></li><li><a href="Item.html#hasBehavior">hasBehavior</a></li><li><a href="Item.html#qualityColorize">qualityColorize</a></li></ul></div></li><li><a href="ItemFactory.html">ItemFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ItemFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ItemFactory.html#create">create</a></li></ul></div></li><li><a href="MobFactory.html">MobFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MobFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="MobFactory.html#create">create</a></li></ul></div></li><li><a href="Npc.html">Npc</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Npc_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Npc.html#getBehavior">getBehavior</a></li><li><a href="Npc.html#hasBehavior">hasBehavior</a></li><li><a href="Npc.html#moveTo">moveTo</a></li></ul></div></li><li><a href="Party.html">Party</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Party_sub"></div></li><li><a href="Player.html">Player</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Player_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Player.html#addPrompt">addPrompt</a></li><li><a href="Player.html#canGo">canGo</a></li><li><a href="Player.html#emit">emit</a></li><li><a href="Player.html#getBroadcastTargets">getBroadcastTargets</a></li><li><a href="Player.html#getMeta">getMeta</a></li><li><a href="Player.html#hasPrompt">hasPrompt</a></li><li><a href="Player.html#interpolatePrompt">interpolatePrompt</a></li><li><a href="Player.html#moveTo">moveTo</a></li><li><a href="Player.html#queueCommand">queueCommand</a></li><li><a href="Player.html#removePrompt">removePrompt</a></li><li><a href="Player.html#setMeta">setMeta</a></li></ul></div></li><li><a href="PlayerClass.html">PlayerClass</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="PlayerClass_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="PlayerClass.html#abilityTable">abilityTable</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="PlayerClass.html#canUseAbility">canUseAbility</a></li><li><a href="PlayerClass.html#getAbilitiesForPlayer">getAbilitiesForPlayer</a></li><li><a href="PlayerClass.html#setupPlayer">setupPlayer</a></li></ul></div></li><li><a href="Quest.html">Quest</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Quest_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Quest.html#emit">emit</a></li><li><a href="Quest.html#getProgress">getProgress</a></li></ul></div></li><li><a href="QuestFactory.html">QuestFactory</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QuestFactory_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="QuestFactory.html#_makeQuestKey">_makeQuestKey</a></li><li><a href="QuestFactory.html#create">create</a></li><li><a href="QuestFactory.html#get">get</a></li></ul></div></li><li><a href="QuestTracker.html">QuestTracker</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="QuestTracker_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="QuestTracker.html#canStart">canStart</a></li><li><a href="QuestTracker.html#complete">complete</a></li><li><a href="QuestTracker.html#emit">emit</a></li><li><a href="QuestTracker.html#hydrate">hydrate</a></li><li><a href="QuestTracker.html#isActive">isActive</a></li><li><a href="QuestTracker.html#isComplete">isComplete</a></li><li><a href="QuestTracker.html#serialize">serialize</a></li><li><a href="QuestTracker.html#start">start</a></li></ul></div></li><li><a href="Room.html">Room</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Room_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Room.html#spawnedNpcs">spawnedNpcs</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Room.html#emit">emit</a></li><li><a href="Room.html#getBehavior">getBehavior</a></li><li><a href="Room.html#getBroadcastTargets">getBroadcastTargets</a></li><li><a href="Room.html#hasBehavior">hasBehavior</a></li></ul></div></li><li><a href="Skill.html">Skill</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Skill_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="Skill.html#cooldown">cooldown</a></li><li><a href="Skill.html#execute">execute</a></li><li><a href="Skill.html#onCooldown">onCooldown</a></li><li><a href="Skill.html#payResourceCosts">payResourceCosts</a></li><li><a href="Skill.html#searchForTargets">searchForTargets</a></li></ul></div></li><li><a href="TelnetServer.html">TelnetServer</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TelnetServer_sub"></div></li><li><a href="TelnetStream.html">TelnetStream</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TelnetStream_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="TelnetStream.html#input">input</a></li><li><a href="TelnetStream.html#telnetCommand">telnetCommand</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#baseAttributeByLevel">baseAttributeByLevel</a></li><li><a href="global.html#diff">diff</a></li><li><a href="global.html#EffectConfig">EffectConfig</a></li><li class="hidden"><a href="global.html#EffectModifiers">EffectModifiers</a></li><li><a href="global.html#expToLevel">expToLevel</a></li><li><a href="global.html#genWrite">genWrite</a></li><li><a href="global.html#HealthPerStaminaTable">HealthPerStaminaTable</a></li><li><a href="global.html#mobExp">mobExp</a></li><li><a href="global.html#reduction">reduction</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*jshint node: true, esversion: 6 */
'use strict';

const fs = require('fs'),
    path = require('path'),
    Data = require('./Data'),
    Area = require('./Area'),
    Command = require('./Command'),
    CommandType = require('./CommandType'),
    Item = require('./Item'),
    Npc = require('./Npc'),
    PlayerClass = require('./PlayerClass'),
    Room = require('./Room'),
    Skill = require('./Skill'),
    SkillType = require('./SkillType'),
    Helpfile = require('./Helpfile'),
    Logger = require('./Logger')
;

const srcPath = __dirname + '/';
const bundlesPath = srcPath + '../bundles/';

class BundleManager {
  constructor(state) {
    this.state = state;
  }

  /**
   * Load in all bundles
   */
  loadBundles() {
    Logger.verbose('LOAD: BUNDLES');

    const bundles = fs.readdirSync(bundlesPath);
    for (const bundle of bundles) {
      const bundlePath = bundlesPath + bundle;
      if (fs.statSync(bundlePath).isFile() || bundle === '.' || bundle === '..') {
        continue;
      }

      // only load bundles the user has configured to be loaded
      if (this.state.Config.get('bundles', []).indexOf(bundle) === -1) {
        continue;
      }

      this.loadBundle(bundle, bundlePath);
    }

    Logger.verbose('ENDLOAD: BUNDLES');

    // Distribution is done after all areas are loaded in case items use areas from each other
    this.state.AreaManager.distribute(this.state);

    this.state.RoomManager.startingRoom = this.state.RoomManager.getRoom(this.state.Config.get('startingRoom'));
    Logger.verbose(`CONFIG: Starting Room [${this.state.RoomManager.startingRoom.entityReference}]`);
  }

  loadBundle(bundle, bundlePath) {
    const features = [
      { path: 'areas/', fn: 'loadAreas' },
      { path: 'behaviors/', fn: 'loadBehaviors' },
      { path: 'channels.js', fn: 'loadChannels' },
      { path: 'classes/', fn: 'loadClasses' },
      { path: 'commands/', fn: 'loadCommands' },
      { path: 'effects/', fn: 'loadEffects' },
      { path: 'help/', fn: 'loadHelp' },
      { path: 'input-events/', fn: 'loadInputEvents' },
      { path: 'player-events.js', fn: 'loadPlayerEvents' },
      { path: 'skills/', fn: 'loadSkills' },
    ];

    Logger.verbose(`LOAD: BUNDLE [\x1B[1;33m${bundle}\x1B[0m] START`);
    for (const feature of features) {
      const path = bundlePath + '/' + feature.path;
      if (fs.existsSync(path)) {
        this[feature.fn](bundle, path);
      }
    }

    Logger.verbose(`ENDLOAD: BUNDLE [\x1B[1;32m${bundle}\x1B[0m]`);
  }

  loadPlayerEvents(bundle, eventsFile) {
    Logger.verbose(`\tLOAD: Player Events...`);

    const playerListeners = require(eventsFile)(srcPath).listeners;

    for (const eventName in playerListeners) {
      if (!playerListeners.hasOwnProperty(eventName)) {
        continue;
      }

      Logger.verbose(`\t\tEvent: ${eventName}`);
      this.state.PlayerManager.addListener(eventName, playerListeners[eventName](this.state));
    }

    Logger.verbose(`\tENDLOAD: Player Events...`);
  }

  loadAreas(bundle, areasDir) {
    Logger.verbose(`\tLOAD: Areas...`);

    const dirs = fs.readdirSync(areasDir);

    for (const areaDir of dirs) {
      if (fs.statSync(areasDir + areaDir).isFile()) {
        continue;
      }

      const areaPath = areasDir + areaDir;
      const areaName = path.basename(areaDir);
      let area = this.loadArea(bundle, areaName, areaPath);
      this.state.AreaManager.addArea(area);
    }

    Logger.verbose(`\tENDLOAD: Areas`);
  }

  loadArea(bundle, areaName, areaPath) {
    var paths = {
      manifest: areaPath + '/manifest.yml',
      rooms: areaPath + '/rooms.yml',
      items: areaPath + '/items.yml',
      npcs: areaPath + '/npcs.yml',
      quests: areaPath + '/quests.js',
    };

    const manifest = Data.parseFile(paths.manifest);

    let area = new Area(bundle, areaName, manifest);

    // load quests
    // Quests have to be loaded first so items/rooms/npcs that are questors have the quest defs available
    if (fs.existsSync(paths.quests)) {
      const rooms = this.loadQuests(area, paths.quests);
    }

    // load items
    if (fs.existsSync(paths.items)) {
      const items = this.loadItems(area, paths.items);
    }

    // load npcs
    if (fs.existsSync(paths.npcs)) {
      const npcs = this.loadNpcs(area, paths.npcs);
    }

    // load rooms
    if (fs.existsSync(paths.rooms)) {
      const rooms = this.loadRooms(area, paths.rooms);
    }

    return area;
  }

  loadItems(area, itemsFile) {
    Logger.verbose(`\t\tLOAD: Items...`);

    // parse the item files
    let items = Data.parseFile(itemsFile);

    // set the item definitions onto the factory
    items.forEach(item => {
      const entityRef = this.state.ItemFactory.createEntityRef(area.name, item.id);
      this.state.ItemFactory.setDefinition(entityRef, item);
      if (item.script) {
        const scriptPath = path.dirname(itemsFile) + '/scripts/items/' + item.script + '.js';
        if (!fs.existsSync(scriptPath)) {
          return;
        }

        Logger.verbose(`\t\t\tLoading Item Script [${entityRef}] ${item.script}`);
        this.loadEntityScript(this.state.ItemFactory, entityRef, scriptPath);
      }
    });

    Logger.verbose(`\t\tENDLOAD: Items`);

    return items;
  }

  loadNpcs(area, npcsFile) {
    Logger.verbose(`\t\tLOAD: Npcs...`);

    // parse the npc files
    let npcs = Data.parseFile(npcsFile);

    // create and load the npcs
    npcs = npcs.map(npc => {
      const entityRef = this.state.MobFactory.createEntityRef(area.name, npc.id);
      this.state.MobFactory.setDefinition(entityRef, npc);

      if (npc.quests) {
        // Update quest definitions with their questor
        for (const qid of npc.quests) {
          const quest = this.state.QuestFactory.get(qid);
          quest.config.npc = entityRef;
          this.state.QuestFactory.set(qid, quest);
        }
      }

      if (npc.script) {
        const scriptPath = path.dirname(npcsFile) + '/scripts/npcs/' + npc.script + '.js';
        if (!fs.existsSync(scriptPath)) {
          return;
        }

        Logger.verbose(`\t\t\tLoading NPC Script [${entityRef}] ${npc.script}`);
        this.loadEntityScript(this.state.MobFactory, entityRef, scriptPath);
      }
    });

    Logger.verbose(`\t\tENDLOAD: Npcs`);

    return npcs;
  }

  loadEntityScript(factory, entityRef, scriptPath) {
    const scriptListeners = require(scriptPath)(srcPath).listeners;

    for (const eventName in scriptListeners) {
      if (!scriptListeners.hasOwnProperty(eventName)) {
        continue;
      }

      Logger.verbose(`\t\t\t\tEvent: ${eventName}`);
      factory.addScriptListener(entityRef, eventName, scriptListeners[eventName](this.state));
    }
  }

  loadRooms(area, roomsFile) {
    Logger.verbose(`\t\tLOAD: Rooms...`);

    // parse the room files
    let rooms = Data.parseFile(roomsFile);

    // create and load the rooms
    rooms = rooms.map(room => new Room(area, room));
    rooms.forEach(room => {
      area.addRoom(room);
      this.state.RoomManager.addRoom(room);
      if (room.script) {
        const scriptPath = path.dirname(roomsFile) + '/scripts/rooms/' + room.script + '.js';
        if (!fs.existsSync(scriptPath)) {
          return;
        }

        Logger.verbose(`\t\t\tLoading Room Script [${area.name}:${room.id}] ${room.script}`);
        // TODO: Maybe abstract this into its own method? Doesn't make much sense now
        // given that rooms are created only once so we can just attach the listeners
        // immediately
        const scriptListeners = require(scriptPath)(srcPath).listeners;
        for (const eventName in scriptListeners) {
          if (!scriptListeners.hasOwnProperty(eventName)) {
            continue;
          }

          Logger.verbose(`\t\t\t\tEvent: ${eventName}`);
          room.on(eventName, scriptListeners[eventName](this.state));
        }
      }
    });

    Logger.verbose(`\t\tENDLOAD: Rooms`);

    return rooms;
  }

  loadQuests(area, questsFile) {
    Logger.verbose(`\t\tLOAD: Quests...`);

    const loader = require(questsFile);
    let quests = loader(srcPath);

    for (const id in quests) {
      Logger.verbose(`\t\t\tLoading Quest [${area.name}:${id}]`);
      this.state.QuestFactory.add(area.name, id, quests[id].config, quests[id].goals);
    }

    Logger.verbose(`\t\tENDLOAD: Quests...`);
  }

  loadCommands(bundle, commandsDir) {
    Logger.verbose(`\tLOAD: Commands...`);
    const files = fs.readdirSync(commandsDir);

    for (const commandFile of files) {
      const commandPath = commandsDir + commandFile;
      if (!fs.statSync(commandPath).isFile() || !commandFile.match(/js$/)) {
        continue;
      }

      const commandName = path.basename(commandFile, path.extname(commandFile));
      const loader = require(commandPath);
      let cmdImport = loader(srcPath, bundlesPath);
      cmdImport.command = cmdImport.command(this.state);


      const command = new Command(
        bundle,
        commandName,
        cmdImport
      );

      this.state.CommandManager.add(command);
    }

    Logger.verbose(`\tENDLOAD: Commands...`);
  }

  loadChannels(bundle, channelsFile) {
    Logger.verbose(`\tLOAD: Channels...`);

    const loader = require(channelsFile);
    let channels = loader(srcPath);

    if (!Array.isArray(channels)) {
      channels = [channels];
    }

    channels.forEach(channel => {
      channel.bundle = bundle;
      this.state.ChannelManager.add(channel);
    });

    Logger.verbose(`\tENDLOAD: Channels...`);
  }

  loadHelp(bundle, helpDir) {
    Logger.verbose(`\tLOAD: Help...`);
    const files = fs.readdirSync(helpDir);

    for (const helpFile of files) {
      const helpPath = helpDir + helpFile;
      if (!fs.statSync(helpPath).isFile()) {
        continue;
      }

      const helpName = path.basename(helpFile, path.extname(helpFile));
      const def = Data.parseFile(helpPath);

      let hfile = null;
      try {
        hfile = new Helpfile(
          bundle,
          helpName,
          def
        );
      } catch (e) {
        Logger.warn(`\t\t${e.message}`);
	continue;
      }

      this.state.HelpManager.add(hfile);
    }

    Logger.verbose(`\tENDLOAD: Help...`);
  }

  loadInputEvents(bundle, inputEventsDir) {
    Logger.verbose(`\tLOAD: Events...`);
    const files = fs.readdirSync(inputEventsDir);

    for (const eventFile of files) {
      const eventPath = inputEventsDir + eventFile;
      if (!fs.statSync(eventPath).isFile() || !eventFile.match(/js$/)) {
        continue;
      }

      const eventName = path.basename(eventFile, path.extname(eventFile));
      const eventImport = require(eventPath)(srcPath);

      this.state.InputEventManager.add(eventName, eventImport.event(this.state));
    }

    Logger.verbose(`\tENDLOAD: Events...`);
  }

  loadBehaviors(bundle, behaviorsDir) {
    Logger.verbose(`\tLOAD: Behaviors...`);

    function loadEntityBehaviors(type, manager, state) {
      let typeDir = behaviorsDir + type + '/';

      if (!fs.existsSync(typeDir)) {
        return;
      }

      Logger.verbose(`\t\tLOAD: BEHAVIORS [${type}]...`);
      const files = fs.readdirSync(typeDir);

      for (const behaviorFile of files) {
        const behaviorPath = typeDir + behaviorFile;
        if (!fs.statSync(behaviorPath).isFile() || !behaviorFile.match(/js$/)) {
          continue;
        }

        const behaviorName = path.basename(behaviorFile, path.extname(behaviorFile));
        Logger.verbose(`\t\t\tLOAD: BEHAVIORS [${type}] ${behaviorName}...`);
        const behaviorListeners = require(behaviorPath)(srcPath).listeners;

        for (const eventName in behaviorListeners) {
          if (!behaviorListeners.hasOwnProperty(eventName)) {
            continue;
          }

          manager.addListener(behaviorName, eventName, behaviorListeners[eventName](state));
        }
      }
    }

    loadEntityBehaviors('npc', this.state.MobBehaviorManager, this.state);
    loadEntityBehaviors('item', this.state.ItemBehaviorManager, this.state);
    loadEntityBehaviors('room', this.state.RoomBehaviorManager, this.state);

    Logger.verbose(`\tENDLOAD: Behaviors...`);
  }

  loadEffects(bundle, effectsDir) {
    Logger.verbose(`\tLOAD: Effects...`);
    const files = fs.readdirSync(effectsDir);

    for (const effectFile of files) {
      const effectPath = effectsDir + effectFile;
      if (!fs.statSync(effectPath).isFile() || !effectFile.match(/js$/)) {
        continue;
      }

      const effectName = path.basename(effectFile, path.extname(effectFile));
      const loader = require(effectPath);

      Logger.verbose(`\t\t${effectName}`);
      this.state.EffectFactory.add(effectName, loader(srcPath));
    }

    Logger.verbose(`\tENDLOAD: Effects...`);
  }

  loadSkills(bundle, skillsDir) {
    Logger.verbose(`\tLOAD: Skills...`);
    const files = fs.readdirSync(skillsDir);

    for (const skillFile of files) {
      const skillPath = skillsDir + skillFile;
      if (!fs.statSync(skillPath).isFile() || !skillFile.match(/js$/)) {
        continue;
      }

      const skillName = path.basename(skillFile, path.extname(skillFile));
      const loader = require(skillPath);
      let skillImport = loader(srcPath);
      if (skillImport.run) {
        skillImport.run = skillImport.run(this.state);
      }

      Logger.verbose(`\t\t${skillName}`);
      const skill = new Skill(skillName, skillImport, this.state);

      if (skill.type === SkillType.SKILL) {
        this.state.SkillManager.add(skill);
      } else {
        this.state.SpellManager.add(skill);
      }
    }

    Logger.verbose(`\tENDLOAD: Skills...`);
  }

  loadClasses(bundle, classesDir) {
    Logger.verbose(`\tLOAD: Classes...`);
    const files = fs.readdirSync(classesDir);

    for (const classFile of files) {
      const classPath = classesDir + classFile;
      if (!fs.statSync(classPath).isFile() || !classFile.match(/js$/)) {
        continue;
      }

      const className = path.basename(classFile, path.extname(classFile));
      const loader = require(classPath);
      let classImport = loader(srcPath);

      Logger.verbose(`\t\t${className}`);
      this.state.ClassManager.set(className, new PlayerClass(className, classImport));
    }

    Logger.verbose(`\tENDLOAD: Classes...`);
  }
}

module.exports = BundleManager;
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="../images/logo.png" style="width: 120px; height: 120px">
    <div class="footer-text">Copyright © 2017, Shawn Biddle</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
