<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="../node_modules/d3/build/d3.js"></script>
    <meta charset="utf-8">
    <style media="screen">
    body {
      font: 10px sans-serif;
      background-color: steelblue;
      text-align: left;
      padding: 3px;
      margin: 1px;
      color: white;
    }
    </style>
    <title>Leveling Charts</title>
  </head>
  <body>
    <h3>Experience needed by level</h3>
    <svg class="tnl-chart" width="1000" height="500">
      <g></g>
    </svg>
    <h3>Attribute points earned by level</h3>
    <svg class="attr-chart" width="1000" height="500">
      <g></g>
    </svg>
    <h3>Skill points earned by level</h3>
    <svg class="skill-chart" width="1000" height="500">
      <g></g>
    </svg>
    <h3>Mutagens earned by level</h3>
    <svg class="mut-chart" width="1000" height="500">
      <g></g>
    </svg>
    <h3>Cost in skill points per skill level</h3>
    <script>
      /**
       * Level utils...
       */

      const reduction = level => {
        let val;
        switch (true) {
          case (level <= 10):
            val = 1;
            break;
          case (level >= 11 && level <= 27):
            val = 1 - (level - 10) / 100;
            break;
          case (level >= 28 && level <= 59):
            val = .82;
            break;
          default:
            val = 1;
        }
        return val;
      };

      /**
       * Difficulty modifier
       * @param int level
       * @return int
       */
      const diff = level => {
        switch (true) {
          case (level <= 5):
            return 0;
          case (level <= 10):
            return 2;
          case (level >= 15):
            return 4;
          case (level >= 20):
            return 6;
          case (level >= 32):
            return 5 + level - 30;
        }
      };

      /**
       * Get the exp that a mob gives
       * @param int level
       * @return int
       */
      const mobExp = level => 45 + (5 * level);

      /**
       * Get the amount of 'hours' a PC can train skills after levelup
       * @param int Player level
       * @return number of times they may train skills.
       */
      const getTrainingTime = level => Math.floor(level / 4 + 1);

      const getMutagenGain = level => {
      	const gainedMutagen = level % 2 === 0;
       	return gainedMutagen ?
      		Math.ceil(level / 10) :
      		0;
      };

      /**
       * Helper to get the amount of experience a player needs to level
       * @param int level Target level
       * @return int
       */
      const expToLevel = level =>
        ((2 * level) + diff(level)) * mobExp(level) * reduction(level);


      // Set up helpers, and create char data.
      const fillArray = (n, v) => [...Array(parseInt(n, 10))].map(() => v);

      const maxLevel      = 60;
      const maxLevelArray = fillArray(maxLevel, {});

      const extrapolate = formula =>
        (acc, _, index) => {
          const previous = acc[index];
          const level = index + 1;
          const cumulative = previous.y + formula(level);
          return acc.concat({
            x: level,
            y: cumulative
          });
        }

      const getAccumulator = () => [{ x: 0, y: 0 }];

      const tnlChartData = maxLevelArray
        .reduce(extrapolate(expToLevel), getAccumulator());

      const attrChartData = maxLevelArray
        .map((_, index) => ({ x: index + 1, y: index + 1 }));

      const skillChartData = maxLevelArray
        .reduce(extrapolate(getTrainingTime), getAccumulator());

      const mutaChartData = maxLevelArray
        .reduce(extrapolate(getMutagenGain), getAccumulator());

      const calcSkillGainCost = level => level === 1 ? 0 : level;

      const maxSkillLevel = 10;
      const skillGainChartData = fillArray(maxSkillLevel, {})
        .reduce(extrapolate(calcSkillGainCost), getAccumulator());

      console.log('Cumulative XP to level: ', tnlChartData);
      console.log('Cumulative attr points by level: ', attrChartData);
      console.log('Cumulative skill points by level: ', skillChartData);
      console.log('Cumulative mutagens by level: ', mutaChartData);
      console.log('Cost to train skill by skill level: ', skillGainChartData);

      /*
        How do d3.js????
      */

      // Use d3.js to create the charts....
      const width = 1000;
      const height = 500;
      const margins = {
        top:    50,
        left:   20,
        right:  20,
        bottom: 100
      };

      const getDomain = (data, axis) => [
        d3.min(data, data => data[axis]),
        d3.max(data, data => data[axis])
      ];

      const getLinearXRange =
        (data) => d3.scaleLinear()
          .range([ margins.left, width - margins.right ])
          .domain(getDomain(data, 'x'));
      const getLinearYRange =
        (data) => d3.scaleLinear()
          .range([ height - margins.top, margins.bottom ])
          .domain(getDomain(data, 'y'));


      const getXAxis = range => d3.axisBottom(range);

      const getYAxis = range => d3.axisRight(range);

      // TODO: Helper functon to create chart obj
      // and attach to element.

      const getChart = data =>{
        const chart = {
          xRange: getLinearXRange(data),
          yRange: getLinearYRange(data),
        };
        chart.xAxis = getXAxis(chart.xRange);
        chart.yAxis = getYAxis(chart.yRange);
        return chart;
      }

      const tnlChart = getChart(tnlChartData);
      const tnlElement = d3.select('.tnl-chart');

      console.log('tnle', tnlElement);

      const getTransformation = trans => 'translate(0, ' + trans + ')';

      tnlElement.append('svg')
        .attr('class', 'y axis')
        .attr('transform', getTransformation(width - margins.right))
        .style('height', data => tnlChart.yRange(data) + 'px')
        .call(tnlChart.yAxis);

      tnlElement.append('svg')
        .attr('class', 'x axis')
        .attr('transform', getTransformation(height - margins.bottom))
        .style('width', data => tnlChart.xRange(data) + 'px')
        .call(tnlChart.xAxis);

        tnlElement.data(tnlChartData);

    </script>

  </body>
</html>
