<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Ranvier</title>
    <style>
    * {
        box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
    }
    #info {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 32px;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        background-color: #444;
        color: #fff;
        border-bottom: 2px solid #666;
    }
    #info > * {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #output {
      font-family: monospace;
      white-space: pre-wrap;
      position: absolute;
      top: 32px;
      left: 0;
      right: 0;
      bottom: 64px;
      background-color: #000;
      color: #e0e0e0;
      padding: 8px;
      overflow-y: auto;
    }
    #input {
      position: absolute;
      width: 100%;
      bottom: 32px;
      left: 0;
      right: 0;
      height: 32px;
      padding: 4px;
      font-size: 16px;
    }
    #healthbar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 32px;
      background-color: #700;
    }
    #hpContainer {
      position: relative;
      height: 100%;
      width: 100%;
    }
    #currentHp {
      height: 100%;
      transition: all 300ms ease;
      background-color: #f00;
    }
    #healthText {
      align-items: center;
      color: #fff;
      display: flex;
      flex-direction: column;
      font-weight: bold;
      height: 32px;
      justify-content: center;
      position: absolute;
      width: 100%;
    }
    </style>
  </head>
  <body>
    <div id="info">
        <div id="playerName"></div>
        <div id="playerLevel"></div>
        <div id="currentArea"></div>
    </div>
    <div id="output"></div>
    <input id="input" type="text"></input>
    <div id="healthbar">
      <div id="hpContainer">
        <div id="healthText"></div>
        <div id="currentHp"></div>
      </div>
    </div>

    <script src="ansi_up.js"></script>
    <script language="javascript" type="text/javascript">
    var wsUri = 'ws://localhost:4000/';
    var output;
    var websocket;
    var ansi_up = new AnsiUp;

    function init()
    {
      output = document.getElementById('output');
      var input = document.getElementById('input');
      input.focus();
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          var message = input.value.trim();
          writeToScreen('SENT: ' + message);
          websocket.send(message);
          input.value = '';
        }
      });
      createWebsocket();
    }

    function createWebsocket()
    {
      websocket = new WebSocket(wsUri);
      websocket.onopen = function(evt) { onOpen(evt) };
      websocket.onclose = function(evt) { onClose(evt) };
      websocket.onmessage = function(evt) { onMessage(evt) };
      websocket.onerror = function(evt) { onError(evt) };
    }

    function onOpen(evt)
    {
      writeToScreen('CONNECTED');
    }

    function onClose(evt)
    {
      writeToScreen('DISCONNECTED');
    }

    function onMessage(evt)
    {
      var data = JSON.parse(evt.data);
      if (data.type === 'message') {
        writeToScreen(data.message);
      } else if (data.type === 'data') {
        updateData(data.data);
      }
    }

    function onError(evt)
    {
      writeToScreen('ERROR: ' + evt.data);
    }

    function writeToScreen(message)
    {
      var span = document.createElement('span');
      span.innerHTML = ansi_up.ansi_to_html(message);
      output.appendChild(span);
      output.scrollTop = output.scrollHeight;
    }

    function updateData(data)
    {
      var current = document.getElementById('currentHp');
      var text = document.getElementById('healthText');
      var healthAttr = data.attributes.health;
      current.style.width = ((healthAttr.current / healthAttr.max) * 100) + '%';
      text.innerHTML = healthAttr.current + '/' + healthAttr.max + ' HP';

      var name = document.getElementById('playerName');
      name.innerHTML = 'Character: ' + data.name;
      var playerLevel = document.getElementById('playerLevel');
      playerLevel.innerHTML = 'Level: ' + data.level;
      var area = document.getElementById('currentArea');
      currentArea.innerHTML = 'Area: ' + data.area;
    }

    window.addEventListener('DOMContentLoaded', init, false);
    window.addEventListener('beforeunload', function () {
      websocket.close();
    });
    </script>
  </body>
</html>
